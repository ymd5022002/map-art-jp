<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>干渉色標高図Leaflet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        html,body,#map {
            height: 100%;
            width: 100%;
            font-family: sans-serif;
            background-color: #ffffff;
            color: #333333;
        }
        .leaflet-control-scale {
            position: absolute;
            bottom: 10px;
            left: 10px;
            margin-bottom: 30px !important;
            margin-left: 0 !important;
        }
    </style>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
</head>
<body style="margin:0">
<table width=100% height=100%>
<tr>
    <td height=23pt>
        <div style="font-size:12pt;font-weight:900">干渉色標高図 (Leaflet版)</div>
    </td>
</tr>
<tr>
    <td width=100%>
        <div style="font-size:9pt;line-height:9pt"><hr size="1"></div>
        <div id="map"></div>
    </td>
</tr>
<tr>
    <td height=40pt>
        <hr size="1">
        <span style="font-size:11pt">色周期(m)：1
            <input id="slider1" type="range" min="1" max="100" step="1" value="25" oninput="updateValue()" onmouseup="updateMap()" ontouchend="updateMap()" />
            <span id="maxValueText">
                <select id="maxValueSelect" onchange="changeMaxValue()">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                    <option value="2000">2000</option>
                    <option value="5000">5000</option>
                </select>
            　</span>
        </span>
        <span id="cc" style="font-size:11pt font-weight:900">25</span>
    </td>
</tr>
</table>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

<script>
    var map;
    var initialC = 25; // 初期のcの値
    var tileUrl = 'https://grt.code4history.dev/tile/{c}/{z}/{x}/{y}';
        //切り替え可能とするタイルレイヤを生成（タイルURL，ズーム範囲，著作権表示などをオプションで設定）

    map = L.map('map').setView([35.6895, 139.6917], 10);

    //ペイン作成→乗算合成
    var pnMulti = map.createPane("Multiply");
    pnMulti.style.mixBlendMode = "multiply";

    var icemap = L.tileLayer('https://grt.code4history.dev/tile/25/{z}/{x}/{y}', {
        minZoom: 5, maxZoom: 18, maxNativeZoom: 14,
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>｜<a href='https://ymd5022002.github.io/map-art-jp/' target='_blank'>地図アート研究所<a> x <a href='https://code4history.dev/index_ja.html' target='_blank'>Code for History</a> 干渉色標高図"
        });

    var hillshade = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png', {
        minZoom: 5, maxZoom: 18, maxNativeZoom: 16,
        opacity: 0.58, pane: pnMulti,
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
        });
    var slope = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/slopemap/{z}/{x}/{y}.png', {
        minZoom: 5, maxZoom: 18, maxNativeZoom: 16,
        opacity: 0.37, pane: pnMulti,
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
        });
    var std = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        minZoom: 5, maxZoom: 18, 
        opacity: 0.71, pane: pnMulti,
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
        });
    var ort = L.tileLayer('http://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', {
        minZoom: 5, maxZoom: 18, 
        opacity: 0.71, pane: pnMulti,
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
        });
    var pal = L.tileLayer('http://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
        minZoom: 5, maxZoom: 18, 
        opacity: 0.71, pane: pnMulti,
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
        });
    var blk = L.tileLayer('http://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png', {
        minZoom: 5, maxZoom: 14, 
        opacity: 0.71, pane: pnMulti,
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
        });
    var osm = L.tileLayer('http://a.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        minZoom: 5, maxZoom: 18, maxNativeZoom: 16,
        opacity: 1.0, pane: pnMulti,
        attribution: "©<a href='https://www.openstreetmap.org/' target='_blank'>OpenStreetMap</a>｜ contributors CC BY-SA2.0"
        });

    //最初に表示するレイヤ
    map.addLayer(icemap);
    map.addLayer(hillshade);
    map.addLayer(slope);

    L.control.layers({
        '干渉色標高図': icemap,
    }, {
        '地理院タイル（標準地図）': std,
        '地理院タイル（写真）': ort,
        '地理院タイル（白地図）': blk,
        '地理院タイル（陰影起伏図）': hillshade,
        '地理院タイル（傾斜量図）': slope,
        //'明治期迅速測図': rapid
        'OpenStreetMap': osm
    }, {
        collapsed: true
    }).addTo(map);

    L.control.scale({imperial: false}).setPosition('bottomleft').addTo(map);

    map.on('moveend', function () {
            var center = map.getCenter();
            var zoom = map.getZoom();
            var selectElement = document.getElementById('maxValueSelect');
            var selectedValue = selectElement.value;
            var sliderValue = document.getElementById('slider1').value;
            setUrlParams(center.lat, center.lng, zoom, selectedValue, sliderValue);
        });

    function getUrlParams() {
        var urlParams = new URLSearchParams(window.location.search);
        var lat = parseFloat(urlParams.get("lat"));
        var lng = parseFloat(urlParams.get("lng"));
        var zoom = parseInt(urlParams.get("zoom"));
        var cc = parseInt(urlParams.get("cc"));
        var cm = parseInt(urlParams.get("cm"));
        if (isNaN(lat) || isNaN(lng) || isNaN(zoom)|| isNaN(cm) || isNaN(cc) ) {
            return null;
        } else {
            return {
                lat: lat,
                lng: lng,
                zoom: zoom,
                cm: cm,
                cc: cc
            };
        }
    }

    function setUrlParams(lat, lng, zoom, cm, cc) {
        var urlParams = new URLSearchParams(window.location.search);
        urlParams.set("lat", lat);
        urlParams.set("lng", lng);
        urlParams.set("zoom", zoom);
        urlParams.set("cm", cm);
        urlParams.set("cc", cc);
        var newUrl = window.location.pathname + "?" + urlParams.toString();
        window.history.replaceState({}, '', newUrl);
    }

    function initializeMap() {
        // URLのクエリパラメータが存在する場合、地図の表示位置とズームレベルを設定します
        var urlParams = getUrlParams();
        if (urlParams) {
            map.setView([urlParams.lat, urlParams.lng], urlParams.zoom);
            var selectElement = document.getElementById('maxValueSelect');
            var selectedValue = selectElement.value;
            var sliderElement = document.getElementById('slider1');
            selectElement.value = urlParams.cm
            sliderElement.value = urlParams.cc
            updateMap();
        }else{
        //URLのクエリパラメータから緯度、経度、ズームレベルを取得して設定します
        var lat = urlParams ? urlParams.lat : 35.6895;
        var lng = urlParams ? urlParams.lng : 139.6917;
        var zoom = urlParams ? urlParams.zoom : 10;
        map.setView([lat, lng], zoom);
        }
    }

    function changeMaxValue() {
        var selectElement = document.getElementById('maxValueSelect');
        var selectedValue = selectElement.value;
        var sliderElement = document.getElementById('slider1');
        sliderElement.setAttribute('max', selectedValue);
        sliderElement.setAttribute('value', selectedValue);
        updateValue();
        updateMap();
    }

    function updateMap() {
        var selectElement = document.getElementById('maxValueSelect');
        var selectedValue = selectElement.value;
        var sliderValue = document.getElementById('slider1').value;
        icemap.setUrl(tileUrl.replace('{c}', sliderValue));
        var center = map.getCenter();
        var zoom = map.getZoom();
        setUrlParams(center.lat, center.lng, zoom, selectedValue, sliderValue)
    }

    function updateValue() {
        var sliderValue = document.getElementById('slider1').value;
        document.getElementById('cc').innerText = sliderValue;       
    }

    initializeMap();
</script>
</body>
</html>
